{"ast":null,"code":"var _jsxFileName = \"/private/var/www/html/dev-app/live-stream-talk/react-front/src/App.js\",\n  _s = $RefreshSig$();\n// src/App.js\nimport React, { useEffect, useRef, useState } from \"react\";\nimport Lottie from \"lottie-react\";\nimport talkingAvatar from \"./talking-avatar.json\";\nimport { GoogleGenAI } from \"@google/genai\";\n\n// Correct Live model id\nimport { jsxDEV as _jsxDEV, Fragment as _Fragment } from \"react/jsx-dev-runtime\";\nconst MODEL = \"gemini-live-2.5-flash-preview\";\n\n// Model → you: 24 kHz PCM\nconst OUTPUT_SAMPLE_RATE = 24000;\n// You → model: 16 kHz PCM\nconst INPUT_SAMPLE_RATE = 16000;\n\n// If you add a CRA proxy, you can switch TOKEN_URL to \"/api/ephemeral-token\"\nconst TOKEN_BASE = process.env.REACT_APP_TOKEN_BASE || \"http://localhost:8787\";\nconst TOKEN_URL = `${TOKEN_BASE}/api/ephemeral-token`;\nexport default function App() {\n  _s();\n  const avatarRef = useRef(null);\n\n  // --- session & audio state ---\n  const [session, setSession] = useState(null);\n  const [isSpeaking, setIsSpeaking] = useState(false);\n\n  // mic + audio contexts\n  const micStreamRef = useRef(null);\n  const inputCtxRef = useRef(null);\n  const outputCtxRef = useRef(null);\n\n  // playback queue (to avoid overlap)\n  const playQueueRef = useRef([]);\n  const drainingRef = useRef(false);\n\n  // websocket open/closed flag\n  const wsOpenRef = useRef(false);\n\n  // Simple VAD-ish flag for logging user voice bursts\n  const voiceActiveRef = useRef(false);\n\n  // Conversation log\n  const [log, setLog] = useState([]);\n\n  // avatar animation tied to speaking\n  useEffect(() => {\n    if (!avatarRef.current) return;\n    if (isSpeaking) avatarRef.current.play();else avatarRef.current.stop();\n  }, [isSpeaking]);\n\n  // ---------- helpers ----------\n\n  function nowHHMMSS() {\n    const d = new Date();\n    const pad = n => String(n).padStart(2, \"0\");\n    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;\n  }\n  function addLog(role, text) {\n    setLog(prev => [...prev, {\n      time: nowHHMMSS(),\n      role,\n      text\n    }]);\n  }\n  function floatTo16BitPCM(float32) {\n    const out = new Int16Array(float32.length);\n    for (let i = 0; i < float32.length; i++) {\n      const s = Math.max(-1, Math.min(1, float32[i]));\n      out[i] = s < 0 ? s * 0x8000 : s * 0x7fff;\n    }\n    return out;\n  }\n  function downsampleTo16k(float32, inRate) {\n    if (inRate === INPUT_SAMPLE_RATE) return float32;\n    const ratio = inRate / INPUT_SAMPLE_RATE;\n    const newLen = Math.floor(float32.length / ratio);\n    const out = new Float32Array(newLen);\n    let pos = 0;\n    for (let i = 0; i < newLen; i++, pos += ratio) {\n      out[i] = float32[Math.floor(pos)];\n    }\n    return out;\n  }\n  function arrayBufferToBase64(ab) {\n    const bytes = new Uint8Array(ab);\n    let bin = \"\";\n    for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);\n    return btoa(bin);\n  }\n  function base64ToInt16(b64) {\n    const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));\n    return new Int16Array(bytes.buffer);\n  }\n\n  // ---------- playback (sequential @24k) ----------\n\n  async function enqueuePlayback(chunk) {\n    let int16;\n    if (typeof chunk === \"string\") int16 = base64ToInt16(chunk);else if (chunk instanceof ArrayBuffer) int16 = new Int16Array(chunk);else return;\n    playQueueRef.current.push(int16);\n    if (!drainingRef.current) drainPlayback();\n  }\n  async function drainPlayback() {\n    drainingRef.current = true;\n    const out = outputCtxRef.current || new (window.AudioContext || window.webkitAudioContext)({\n      sampleRate: OUTPUT_SAMPLE_RATE\n    });\n    if (!outputCtxRef.current) outputCtxRef.current = out;\n    while (playQueueRef.current.length) {\n      const int16 = playQueueRef.current.shift();\n      const f32 = new Float32Array(int16.length);\n      for (let i = 0; i < int16.length; i++) f32[i] = int16[i] / 0x8000;\n      const buf = out.createBuffer(1, f32.length, OUTPUT_SAMPLE_RATE);\n      buf.copyToChannel(f32, 0);\n      await new Promise(resolve => {\n        const src = out.createBufferSource();\n        src.buffer = buf;\n        src.connect(out.destination);\n        setIsSpeaking(true);\n        src.start();\n        src.onended = () => {\n          setIsSpeaking(false);\n          resolve();\n        };\n      });\n    }\n    drainingRef.current = false;\n  }\n  function extractMessageText(msg) {\n    var _sc$modelTurn;\n    if (typeof (msg === null || msg === void 0 ? void 0 : msg.text) === \"string\" && msg.text.trim()) return msg.text.trim();\n    const sc = msg === null || msg === void 0 ? void 0 : msg.serverContent;\n    if (sc !== null && sc !== void 0 && sc.output && Array.isArray(sc.output)) {\n      const t = sc.output.map(o => o === null || o === void 0 ? void 0 : o.text).filter(Boolean).join(\" \").trim();\n      if (t) return t;\n    }\n    if (sc !== null && sc !== void 0 && (_sc$modelTurn = sc.modelTurn) !== null && _sc$modelTurn !== void 0 && _sc$modelTurn.parts) {\n      const t = sc.modelTurn.parts.map(p => typeof (p === null || p === void 0 ? void 0 : p.text) === \"string\" ? p.text : \"\").join(\" \").trim();\n      if (t) return t;\n    }\n    if (Array.isArray(msg === null || msg === void 0 ? void 0 : msg.candidates)) {\n      for (const c of msg.candidates) {\n        var _c$content, _c$content$parts;\n        const t = c === null || c === void 0 ? void 0 : (_c$content = c.content) === null || _c$content === void 0 ? void 0 : (_c$content$parts = _c$content.parts) === null || _c$content$parts === void 0 ? void 0 : _c$content$parts.map(p => typeof (p === null || p === void 0 ? void 0 : p.text) === \"string\" ? p.text : \"\").join(\" \").trim();\n        if (t) return t;\n      }\n    }\n    return null;\n  }\n\n  // ---------- mic start/stop, guarded by wsOpen ----------\n\n  async function startMicAndStream(s) {\n    // open mic\n    const stream = await navigator.mediaDevices.getUserMedia({\n      audio: true\n    });\n    micStreamRef.current = stream;\n    const inCtx = new (window.AudioContext || window.webkitAudioContext)();\n    inputCtxRef.current = inCtx;\n    const src = inCtx.createMediaStreamSource(stream);\n    const proc = inCtx.createScriptProcessor(4096, 1, 1);\n\n    // keep node alive but mute locally to avoid loopback\n    const nullOut = inCtx.createGain();\n    nullOut.gain.value = 0;\n    src.connect(proc);\n    proc.connect(nullOut);\n    nullOut.connect(inCtx.destination);\n    proc.onaudioprocess = e => {\n      if (!wsOpenRef.current) return; // ⛔ don't send if WS not open\n\n      const ch = e.inputBuffer.getChannelData(0);\n\n      // naive voice activity marker for the log\n      const rms = ch.reduce((acc, v) => acc + Math.abs(v), 0) / Math.max(1, ch.length);\n      const talking = rms > 0.02;\n      if (talking && !voiceActiveRef.current) {\n        voiceActiveRef.current = true;\n        addLog(\"user\", \"[voice]\");\n      } else if (!talking && voiceActiveRef.current) {\n        voiceActiveRef.current = false;\n      }\n      const ds = downsampleTo16k(ch, inCtx.sampleRate);\n      const pcm16 = floatTo16BitPCM(ds);\n      const b64 = arrayBufferToBase64(pcm16.buffer);\n\n      // send only when open\n      try {\n        s.sendRealtimeInput({\n          audio: {\n            data: b64,\n            mimeType: `audio/pcm;rate=${INPUT_SAMPLE_RATE}`\n          }\n        });\n      } catch (err) {\n        // swallow errors that happen during closing; the guard prevents most of them\n      }\n    };\n  }\n  async function stopEverything() {\n    // stop mic tracks\n    if (micStreamRef.current) {\n      micStreamRef.current.getTracks().forEach(t => t.stop());\n      micStreamRef.current = null;\n    }\n    // close input context\n    if (inputCtxRef.current) {\n      try {\n        await inputCtxRef.current.close();\n      } catch {}\n      inputCtxRef.current = null;\n    }\n    // clear playback queue & close output context\n    playQueueRef.current = [];\n    drainingRef.current = false;\n    if (outputCtxRef.current) {\n      try {\n        await outputCtxRef.current.close();\n      } catch {}\n      outputCtxRef.current = null;\n    }\n    // close session\n    if (session) {\n      try {\n        var _session$close;\n        await ((_session$close = session.close) === null || _session$close === void 0 ? void 0 : _session$close.call(session));\n      } catch {}\n      setSession(null);\n    }\n    wsOpenRef.current = false;\n    setIsSpeaking(false);\n    voiceActiveRef.current = false;\n    addLog(\"system\", \"Stopped\");\n  }\n\n  // ---------- Live start/stop ----------\n\n  const startLive = async () => {\n    if (session) return; // already running\n\n    // 1) get ephemeral token (must be v1alpha on client)\n    const res = await fetch(TOKEN_URL);\n    const json = await res.json();\n    const tokenVal = json === null || json === void 0 ? void 0 : json.token;\n    const ephemeralKey = typeof tokenVal === \"string\" ? tokenVal : tokenVal === null || tokenVal === void 0 ? void 0 : tokenVal.name;\n    if (!ephemeralKey) {\n      addLog(\"system\", \"Failed to fetch ephemeral token\");\n      return;\n    }\n    const ai = new GoogleGenAI({\n      apiKey: ephemeralKey,\n      httpOptions: {\n        apiVersion: \"v1alpha\"\n      }\n    });\n\n    // small helper to await onopen before starting mic\n    let resolveOpen;\n    const opened = new Promise(resolve => resolveOpen = resolve);\n    const s = await ai.live.connect({\n      model: MODEL,\n      config: {\n        responseModalities: [\"AUDIO\", \"TEXT\"],\n        speechConfig: {\n          languageCode: \"hi-IN\",\n          voiceConfig: {\n            prebuiltVoiceConfig: {\n              voiceName: \"Puck\"\n            }\n          }\n        }\n      },\n      callbacks: {\n        onopen: () => {\n          wsOpenRef.current = true;\n          addLog(\"system\", \"Live connected\");\n          resolveOpen();\n        },\n        onmessage: msg => {\n          var _msg$speechUpdate$aud, _msg$speechUpdate;\n          const audio = (_msg$speechUpdate$aud = msg === null || msg === void 0 ? void 0 : (_msg$speechUpdate = msg.speechUpdate) === null || _msg$speechUpdate === void 0 ? void 0 : _msg$speechUpdate.audio) !== null && _msg$speechUpdate$aud !== void 0 ? _msg$speechUpdate$aud : msg === null || msg === void 0 ? void 0 : msg.data;\n          if (audio) enqueuePlayback(audio);\n          const text = extractMessageText(msg);\n          if (text) addLog(\"ai\", text);\n        },\n        onerror: e => {\n          console.error(\"Live error:\", e);\n          addLog(\"system\", `Error: ${String((e === null || e === void 0 ? void 0 : e.message) || e)}`);\n        },\n        onclose: () => {\n          wsOpenRef.current = false;\n          addLog(\"system\", \"Live session closed\");\n          // proactively stop mic if socket closes\n          stopEverything();\n        }\n      }\n    });\n    setSession(s);\n\n    // 2) wait until WS is OPEN before starting mic streaming\n    await opened;\n\n    // 3) start mic capture & streaming\n    await startMicAndStream(s);\n  };\n  const stopLive = async () => {\n    await stopEverything();\n  };\n\n  // Send a text turn\n  const [textInput, setTextInput] = useState(\"\");\n  const sendText = async text => {\n    if (!session || !(text !== null && text !== void 0 && text.trim())) return;\n    const clean = text.trim();\n    addLog(\"user\", clean);\n    // Only send if socket is open\n    if (!wsOpenRef.current) return;\n    session.sendClientContent({\n      text: clean,\n      turnComplete: true\n    });\n  };\n\n  // Cleanup on tab close\n  useEffect(() => {\n    const onUnload = () => {\n      try {\n        stopEverything();\n      } catch {}\n    };\n    window.addEventListener(\"beforeunload\", onUnload);\n    return () => window.removeEventListener(\"beforeunload\", onUnload);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [session]);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"app\",\n    style: {\n      maxWidth: 720,\n      margin: \"24px auto\",\n      padding: 16\n    },\n    children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n      children: \"Talking AI Avatar (Gemini Live)\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 347,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(Lottie, {\n      lottieRef: avatarRef,\n      animationData: talkingAvatar,\n      loop: true,\n      autoplay: false,\n      style: {\n        height: 300\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 349,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        display: \"flex\",\n        gap: 8,\n        marginTop: 12\n      },\n      children: !session ? /*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: startLive,\n        children: \"Start Live\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 359,\n        columnNumber: 11\n      }, this) : /*#__PURE__*/_jsxDEV(_Fragment, {\n        children: [/*#__PURE__*/_jsxDEV(\"input\", {\n          style: {\n            flex: 1,\n            padding: 8\n          },\n          placeholder: \"Type a message\\u2026\",\n          value: textInput,\n          onChange: e => setTextInput(e.target.value),\n          onKeyDown: e => {\n            if (e.key === \"Enter\") {\n              sendText(textInput);\n              setTextInput(\"\");\n            }\n          }\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 362,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => {\n            sendText(textInput);\n            setTextInput(\"\");\n          },\n          children: \"Send\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 374,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: stopLive,\n          children: \"Stop\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 382,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 357,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n      style: {\n        opacity: 0.7,\n        marginTop: 8\n      },\n      children: wsOpenRef.current ? isSpeaking ? \"Model is speaking…\" : \"Live connected. Speak into your mic.\" : session ? \"Connecting…\" : \"Click Start Live and allow mic permission.\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 387,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n      style: {\n        marginTop: 16,\n        padding: 12,\n        border: \"1px solid #ddd\",\n        borderRadius: 8,\n        background: \"#fafafa\",\n        maxHeight: 280,\n        overflow: \"auto\",\n        fontFamily: \"ui-monospace, SFMono-Regular, Menlo, monospace\",\n        fontSize: 14\n      },\n      children: log.length === 0 ? /*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          opacity: 0.6\n        },\n        children: \"No messages yet.\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 412,\n        columnNumber: 11\n      }, this) : log.map((m, i) => /*#__PURE__*/_jsxDEV(\"div\", {\n        style: {\n          marginBottom: 6\n        },\n        children: [/*#__PURE__*/_jsxDEV(\"span\", {\n          style: {\n            opacity: 0.6,\n            marginRight: 8\n          },\n          children: [\"[\", m.time, \"]\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 416,\n          columnNumber: 15\n        }, this), /*#__PURE__*/_jsxDEV(\"strong\", {\n          style: {\n            textTransform: \"capitalize\"\n          },\n          children: [m.role, \":\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 417,\n          columnNumber: 15\n        }, this), \" \", /*#__PURE__*/_jsxDEV(\"span\", {\n          children: m.text\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 418,\n          columnNumber: 15\n        }, this)]\n      }, i, true, {\n        fileName: _jsxFileName,\n        lineNumber: 415,\n        columnNumber: 13\n      }, this))\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 398,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 346,\n    columnNumber: 5\n  }, this);\n}\n_s(App, \"x4yOYXW/r6W2CcMGcX35b7rrqcs=\");\n_c = App;\nvar _c;\n$RefreshReg$(_c, \"App\");","map":{"version":3,"names":["React","useEffect","useRef","useState","Lottie","talkingAvatar","GoogleGenAI","jsxDEV","_jsxDEV","Fragment","_Fragment","MODEL","OUTPUT_SAMPLE_RATE","INPUT_SAMPLE_RATE","TOKEN_BASE","process","env","REACT_APP_TOKEN_BASE","TOKEN_URL","App","_s","avatarRef","session","setSession","isSpeaking","setIsSpeaking","micStreamRef","inputCtxRef","outputCtxRef","playQueueRef","drainingRef","wsOpenRef","voiceActiveRef","log","setLog","current","play","stop","nowHHMMSS","d","Date","pad","n","String","padStart","getHours","getMinutes","getSeconds","addLog","role","text","prev","time","floatTo16BitPCM","float32","out","Int16Array","length","i","s","Math","max","min","downsampleTo16k","inRate","ratio","newLen","floor","Float32Array","pos","arrayBufferToBase64","ab","bytes","Uint8Array","bin","fromCharCode","btoa","base64ToInt16","b64","from","atob","c","charCodeAt","buffer","enqueuePlayback","chunk","int16","ArrayBuffer","push","drainPlayback","window","AudioContext","webkitAudioContext","sampleRate","shift","f32","buf","createBuffer","copyToChannel","Promise","resolve","src","createBufferSource","connect","destination","start","onended","extractMessageText","msg","_sc$modelTurn","trim","sc","serverContent","output","Array","isArray","t","map","o","filter","Boolean","join","modelTurn","parts","p","candidates","_c$content","_c$content$parts","content","startMicAndStream","stream","navigator","mediaDevices","getUserMedia","audio","inCtx","createMediaStreamSource","proc","createScriptProcessor","nullOut","createGain","gain","value","onaudioprocess","e","ch","inputBuffer","getChannelData","rms","reduce","acc","v","abs","talking","ds","pcm16","sendRealtimeInput","data","mimeType","err","stopEverything","getTracks","forEach","close","_session$close","call","startLive","res","fetch","json","tokenVal","token","ephemeralKey","name","ai","apiKey","httpOptions","apiVersion","resolveOpen","opened","live","model","config","responseModalities","speechConfig","languageCode","voiceConfig","prebuiltVoiceConfig","voiceName","callbacks","onopen","onmessage","_msg$speechUpdate$aud","_msg$speechUpdate","speechUpdate","onerror","console","error","message","onclose","stopLive","textInput","setTextInput","sendText","clean","sendClientContent","turnComplete","onUnload","addEventListener","removeEventListener","className","style","maxWidth","margin","padding","children","fileName","_jsxFileName","lineNumber","columnNumber","lottieRef","animationData","loop","autoplay","height","display","gap","marginTop","onClick","flex","placeholder","onChange","target","onKeyDown","key","opacity","border","borderRadius","background","maxHeight","overflow","fontFamily","fontSize","m","marginBottom","marginRight","textTransform","_c","$RefreshReg$"],"sources":["/private/var/www/html/dev-app/live-stream-talk/react-front/src/App.js"],"sourcesContent":["// src/App.js\nimport React, { useEffect, useRef, useState } from \"react\";\nimport Lottie from \"lottie-react\";\nimport talkingAvatar from \"./talking-avatar.json\";\nimport { GoogleGenAI } from \"@google/genai\";\n\n// Correct Live model id\nconst MODEL = \"gemini-live-2.5-flash-preview\";\n\n// Model → you: 24 kHz PCM\nconst OUTPUT_SAMPLE_RATE = 24000;\n// You → model: 16 kHz PCM\nconst INPUT_SAMPLE_RATE = 16000;\n\n// If you add a CRA proxy, you can switch TOKEN_URL to \"/api/ephemeral-token\"\nconst TOKEN_BASE = process.env.REACT_APP_TOKEN_BASE || \"http://localhost:8787\";\nconst TOKEN_URL = `${TOKEN_BASE}/api/ephemeral-token`;\n\nexport default function App() {\n  const avatarRef = useRef(null);\n\n  // --- session & audio state ---\n  const [session, setSession] = useState(null);\n  const [isSpeaking, setIsSpeaking] = useState(false);\n\n  // mic + audio contexts\n  const micStreamRef = useRef(null);\n  const inputCtxRef = useRef(null);\n  const outputCtxRef = useRef(null);\n\n  // playback queue (to avoid overlap)\n  const playQueueRef = useRef([]);\n  const drainingRef = useRef(false);\n\n  // websocket open/closed flag\n  const wsOpenRef = useRef(false);\n\n  // Simple VAD-ish flag for logging user voice bursts\n  const voiceActiveRef = useRef(false);\n\n  // Conversation log\n  const [log, setLog] = useState([]);\n\n  // avatar animation tied to speaking\n  useEffect(() => {\n    if (!avatarRef.current) return;\n    if (isSpeaking) avatarRef.current.play();\n    else avatarRef.current.stop();\n  }, [isSpeaking]);\n\n  // ---------- helpers ----------\n\n  function nowHHMMSS() {\n    const d = new Date();\n    const pad = (n) => String(n).padStart(2, \"0\");\n    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;\n  }\n  function addLog(role, text) {\n    setLog((prev) => [...prev, { time: nowHHMMSS(), role, text }]);\n  }\n\n  function floatTo16BitPCM(float32) {\n    const out = new Int16Array(float32.length);\n    for (let i = 0; i < float32.length; i++) {\n      const s = Math.max(-1, Math.min(1, float32[i]));\n      out[i] = s < 0 ? s * 0x8000 : s * 0x7fff;\n    }\n    return out;\n  }\n  function downsampleTo16k(float32, inRate) {\n    if (inRate === INPUT_SAMPLE_RATE) return float32;\n    const ratio = inRate / INPUT_SAMPLE_RATE;\n    const newLen = Math.floor(float32.length / ratio);\n    const out = new Float32Array(newLen);\n    let pos = 0;\n    for (let i = 0; i < newLen; i++, pos += ratio) {\n      out[i] = float32[Math.floor(pos)];\n    }\n    return out;\n  }\n  function arrayBufferToBase64(ab) {\n    const bytes = new Uint8Array(ab);\n    let bin = \"\";\n    for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);\n    return btoa(bin);\n  }\n  function base64ToInt16(b64) {\n    const bytes = Uint8Array.from(atob(b64), (c) => c.charCodeAt(0));\n    return new Int16Array(bytes.buffer);\n  }\n\n  // ---------- playback (sequential @24k) ----------\n\n  async function enqueuePlayback(chunk) {\n    let int16;\n    if (typeof chunk === \"string\") int16 = base64ToInt16(chunk);\n    else if (chunk instanceof ArrayBuffer) int16 = new Int16Array(chunk);\n    else return;\n\n    playQueueRef.current.push(int16);\n    if (!drainingRef.current) drainPlayback();\n  }\n\n  async function drainPlayback() {\n    drainingRef.current = true;\n\n    const out =\n      outputCtxRef.current ||\n      new (window.AudioContext || window.webkitAudioContext)({\n        sampleRate: OUTPUT_SAMPLE_RATE,\n      });\n    if (!outputCtxRef.current) outputCtxRef.current = out;\n\n    while (playQueueRef.current.length) {\n      const int16 = playQueueRef.current.shift();\n\n      const f32 = new Float32Array(int16.length);\n      for (let i = 0; i < int16.length; i++) f32[i] = int16[i] / 0x8000;\n\n      const buf = out.createBuffer(1, f32.length, OUTPUT_SAMPLE_RATE);\n      buf.copyToChannel(f32, 0);\n\n      await new Promise((resolve) => {\n        const src = out.createBufferSource();\n        src.buffer = buf;\n        src.connect(out.destination);\n        setIsSpeaking(true);\n        src.start();\n        src.onended = () => {\n          setIsSpeaking(false);\n          resolve();\n        };\n      });\n    }\n\n    drainingRef.current = false;\n  }\n\n  function extractMessageText(msg) {\n    if (typeof msg?.text === \"string\" && msg.text.trim()) return msg.text.trim();\n    const sc = msg?.serverContent;\n    if (sc?.output && Array.isArray(sc.output)) {\n      const t = sc.output.map((o) => o?.text).filter(Boolean).join(\" \").trim();\n      if (t) return t;\n    }\n    if (sc?.modelTurn?.parts) {\n      const t = sc.modelTurn.parts\n        .map((p) => (typeof p?.text === \"string\" ? p.text : \"\"))\n        .join(\" \")\n        .trim();\n      if (t) return t;\n    }\n    if (Array.isArray(msg?.candidates)) {\n      for (const c of msg.candidates) {\n        const t = c?.content?.parts\n          ?.map((p) => (typeof p?.text === \"string\" ? p.text : \"\"))\n          .join(\" \")\n          .trim();\n        if (t) return t;\n      }\n    }\n    return null;\n  }\n\n  // ---------- mic start/stop, guarded by wsOpen ----------\n\n  async function startMicAndStream(s) {\n    // open mic\n    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n    micStreamRef.current = stream;\n\n    const inCtx = new (window.AudioContext || window.webkitAudioContext)();\n    inputCtxRef.current = inCtx;\n\n    const src = inCtx.createMediaStreamSource(stream);\n    const proc = inCtx.createScriptProcessor(4096, 1, 1);\n\n    // keep node alive but mute locally to avoid loopback\n    const nullOut = inCtx.createGain();\n    nullOut.gain.value = 0;\n    src.connect(proc);\n    proc.connect(nullOut);\n    nullOut.connect(inCtx.destination);\n\n    proc.onaudioprocess = (e) => {\n      if (!wsOpenRef.current) return; // ⛔ don't send if WS not open\n\n      const ch = e.inputBuffer.getChannelData(0);\n\n      // naive voice activity marker for the log\n      const rms =\n        ch.reduce((acc, v) => acc + Math.abs(v), 0) / Math.max(1, ch.length);\n      const talking = rms > 0.02;\n      if (talking && !voiceActiveRef.current) {\n        voiceActiveRef.current = true;\n        addLog(\"user\", \"[voice]\");\n      } else if (!talking && voiceActiveRef.current) {\n        voiceActiveRef.current = false;\n      }\n\n      const ds = downsampleTo16k(ch, inCtx.sampleRate);\n      const pcm16 = floatTo16BitPCM(ds);\n      const b64 = arrayBufferToBase64(pcm16.buffer);\n\n      // send only when open\n      try {\n        s.sendRealtimeInput({\n          audio: { data: b64, mimeType: `audio/pcm;rate=${INPUT_SAMPLE_RATE}` },\n        });\n      } catch (err) {\n        // swallow errors that happen during closing; the guard prevents most of them\n      }\n    };\n  }\n\n  async function stopEverything() {\n    // stop mic tracks\n    if (micStreamRef.current) {\n      micStreamRef.current.getTracks().forEach((t) => t.stop());\n      micStreamRef.current = null;\n    }\n    // close input context\n    if (inputCtxRef.current) {\n      try {\n        await inputCtxRef.current.close();\n      } catch {}\n      inputCtxRef.current = null;\n    }\n    // clear playback queue & close output context\n    playQueueRef.current = [];\n    drainingRef.current = false;\n    if (outputCtxRef.current) {\n      try {\n        await outputCtxRef.current.close();\n      } catch {}\n      outputCtxRef.current = null;\n    }\n    // close session\n    if (session) {\n      try {\n        await session.close?.();\n      } catch {}\n      setSession(null);\n    }\n    wsOpenRef.current = false;\n    setIsSpeaking(false);\n    voiceActiveRef.current = false;\n    addLog(\"system\", \"Stopped\");\n  }\n\n  // ---------- Live start/stop ----------\n\n  const startLive = async () => {\n    if (session) return; // already running\n\n    // 1) get ephemeral token (must be v1alpha on client)\n    const res = await fetch(TOKEN_URL);\n    const json = await res.json();\n    const tokenVal = json?.token;\n    const ephemeralKey = typeof tokenVal === \"string\" ? tokenVal : tokenVal?.name;\n    if (!ephemeralKey) {\n      addLog(\"system\", \"Failed to fetch ephemeral token\");\n      return;\n    }\n\n    const ai = new GoogleGenAI({\n      apiKey: ephemeralKey,\n      httpOptions: { apiVersion: \"v1alpha\" },\n    });\n\n    // small helper to await onopen before starting mic\n    let resolveOpen;\n    const opened = new Promise((resolve) => (resolveOpen = resolve));\n\n    const s = await ai.live.connect({\n      model: MODEL,\n      config: {\n        responseModalities: [\"AUDIO\", \"TEXT\"],\n        speechConfig: {\n          languageCode: \"hi-IN\",\n          voiceConfig: { prebuiltVoiceConfig: { voiceName: \"Puck\" } },\n        },\n      },\n      callbacks: {\n        onopen: () => {\n          wsOpenRef.current = true;\n          addLog(\"system\", \"Live connected\");\n          resolveOpen();\n        },\n        onmessage: (msg) => {\n          const audio = msg?.speechUpdate?.audio ?? msg?.data;\n          if (audio) enqueuePlayback(audio);\n          const text = extractMessageText(msg);\n          if (text) addLog(\"ai\", text);\n        },\n        onerror: (e) => {\n          console.error(\"Live error:\", e);\n          addLog(\"system\", `Error: ${String(e?.message || e)}`);\n        },\n        onclose: () => {\n          wsOpenRef.current = false;\n          addLog(\"system\", \"Live session closed\");\n          // proactively stop mic if socket closes\n          stopEverything();\n        },\n      },\n    });\n\n    setSession(s);\n\n    // 2) wait until WS is OPEN before starting mic streaming\n    await opened;\n\n    // 3) start mic capture & streaming\n    await startMicAndStream(s);\n  };\n\n  const stopLive = async () => {\n    await stopEverything();\n  };\n\n  // Send a text turn\n  const [textInput, setTextInput] = useState(\"\");\n  const sendText = async (text) => {\n    if (!session || !text?.trim()) return;\n    const clean = text.trim();\n    addLog(\"user\", clean);\n    // Only send if socket is open\n    if (!wsOpenRef.current) return;\n    session.sendClientContent({ text: clean, turnComplete: true });\n  };\n\n  // Cleanup on tab close\n  useEffect(() => {\n    const onUnload = () => {\n      try {\n        stopEverything();\n      } catch {}\n    };\n    window.addEventListener(\"beforeunload\", onUnload);\n    return () => window.removeEventListener(\"beforeunload\", onUnload);\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [session]);\n\n  return (\n    <div className=\"app\" style={{ maxWidth: 720, margin: \"24px auto\", padding: 16 }}>\n      <h2>Talking AI Avatar (Gemini Live)</h2>\n\n      <Lottie\n        lottieRef={avatarRef}\n        animationData={talkingAvatar}\n        loop\n        autoplay={false}\n        style={{ height: 300 }}\n      />\n\n      <div style={{ display: \"flex\", gap: 8, marginTop: 12 }}>\n        {!session ? (\n          <button onClick={startLive}>Start Live</button>\n        ) : (\n          <>\n            <input\n              style={{ flex: 1, padding: 8 }}\n              placeholder=\"Type a message…\"\n              value={textInput}\n              onChange={(e) => setTextInput(e.target.value)}\n              onKeyDown={(e) => {\n                if (e.key === \"Enter\") {\n                  sendText(textInput);\n                  setTextInput(\"\");\n                }\n              }}\n            />\n            <button\n              onClick={() => {\n                sendText(textInput);\n                setTextInput(\"\");\n              }}\n            >\n              Send\n            </button>\n            <button onClick={stopLive}>Stop</button>\n          </>\n        )}\n      </div>\n\n      <p style={{ opacity: 0.7, marginTop: 8 }}>\n        {wsOpenRef.current\n          ? isSpeaking\n            ? \"Model is speaking…\"\n            : \"Live connected. Speak into your mic.\"\n          : session\n          ? \"Connecting…\"\n          : \"Click Start Live and allow mic permission.\"}\n      </p>\n\n      {/* Conversation Log */}\n      <div\n        style={{\n          marginTop: 16,\n          padding: 12,\n          border: \"1px solid #ddd\",\n          borderRadius: 8,\n          background: \"#fafafa\",\n          maxHeight: 280,\n          overflow: \"auto\",\n          fontFamily: \"ui-monospace, SFMono-Regular, Menlo, monospace\",\n          fontSize: 14,\n        }}\n      >\n        {log.length === 0 ? (\n          <div style={{ opacity: 0.6 }}>No messages yet.</div>\n        ) : (\n          log.map((m, i) => (\n            <div key={i} style={{ marginBottom: 6 }}>\n              <span style={{ opacity: 0.6, marginRight: 8 }}>[{m.time}]</span>\n              <strong style={{ textTransform: \"capitalize\" }}>{m.role}:</strong>{\" \"}\n              <span>{m.text}</span>\n            </div>\n          ))\n        )}\n      </div>\n    </div>\n  );\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}